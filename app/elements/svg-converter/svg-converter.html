<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../styles/app-theme.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="svg-converter">
  <template>
    <style>
      :host {
        display: block;
        --paper-tabs-selection-bar-color: var(--accent-color);
      }
      paper-tab {
        --paper-tab-ink: var(--accent-color);
        --paper-tab: {
          background: var(--primary-background-color);
        }
      }
      paper-button, paper-dropdown-menu {
        display: block;
      }
      paper-button {
        background: var(--svg-converter-button-background, --accent-color);
        margin: 1em;
      }
      paper-material {
        background: white;
      }
    </style>
    <paper-tabs selected="{{selected}}">
      <paper-tab>Input</paper-tab>
      <paper-tab>Output</paper-tab>
    </paper-tabs>
    <iron-pages selected="{{selected}}">
      <paper-card>
        <paper-material elevation="1" class="card-content">
          <content id="svg" select="svg"></content>
        </paper-material>
        <div class="card-actions">
          <paper-input label="File Name" value="{{file}}"></paper-input>
          <paper-dropdown-menu value="{{format}}" label="Format" selected="1">
            <paper-listbox class="dropdown-content">
              <paper-item>png</paper-item>
              <paper-item>svg</paper-item>
              <paper-item>ico</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-button id="convert" on-tap="convert" raised>Convert</paper-button>
        </div>
      </paper-card>
      <paper-card>
        <paper-material elevation="1" class="card-content">
          <canvas id="canvas"></canvas>
        </paper-material>
        <div class="card-actions">
          <paper-button id="download" on-tap="download" raised>Download</paper-button>
        </div>
      </paper-card>
    </iron-pages>
    <a id="link" hidden href="{{href}}" download="{{file}}.{{format}}" target="_blank"></a>
  </template>
  <script>
    Polymer({ is: 'svg-converter',
      properties: {
        file: {
          type: String,
          value: 'output',
        },
        href: {
          type: String,
        },
        format: {
          type: String,
          value: 'png',
        },
      },
      convert: function () {
        var ctx = this.$.canvas.getContext('2d');
        var svg = this.getContentChildren('#svg')[0];
        var data = (new XMLSerializer()).serializeToString(svg);
        var DOMURL = window.URL || window.webkitURL || window;

        var img = new Image();
        var blob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
        var url = DOMURL.createObjectURL(blob);

        img.onload = () => {
          ctx.drawImage(img, 0, 0);
          DOMURL.revokeObjectURL(url);
          this.set('href', this.$.canvas.toDataURL('image/png')
            .replace('image/png', 'image/octet-stream'));
        };

        img.src = url;
      },

      download: function () {
        this.$.link.dispatchEvent(new MouseEvent('click', {
          view: window,
          bubbles: false,
          cancelable: true,
        }));
      },

    });
  </script>
</dom-module>
