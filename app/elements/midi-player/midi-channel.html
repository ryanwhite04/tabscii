<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="resources.html">

<dom-module id="midi-channel">
  <template>
    <style>
      paper-card {
        max-width: 240px;
      }
    </style>
    <select name="instrument" id="" value="{{instrumentId::change}}">
      <template is="dom-repeat" items="{{instruments.byCategory}}" as="category">
        <optgroup label="{{category.name}}">
          <template is="dom-repeat"
            items="{{instruments.byId}}"
            as="instrument"
            filter="{{filterInstruments(category.name)}}">
            <option value="{{instrument.number}}">{{instrument.instrument}}</option>
          </template>
        </optgroup>
      </template>
    </select>
    <paper-card image="{{image}}">
      <div class="card-content">Instrument: {{instrument.instrument}}</div>
      <div class="card-content">Category: {{instrument.category}}</div>
      <div class="card-content">Key: {{key}}</div>
    </paper-card>
  </template>
  <script>
    Polymer({ is: 'midi-channel',
      properties: {
        note: {
          type: Number,
          notify: true,
        },
        key: {
          type: String,
          notify: true,
        },
        instruments: {
          type: Object,
          value: function() {
            var instrumentsByCategory = [];
            for (var instrument in MIDI.GM.byCategory) {
              instrumentsByCategory.push({
                name: MIDI.GM.byCategory[instrument].category,
                id: instrument,
              });
            }
            MIDI.GM.byCategory = instrumentsByCategory;
            MIDI.GM.byId = Object.keys(MIDI.GM.byId).map(key => MIDI.GM.byId[key])
            return MIDI.GM;
          },
        },
        instrumentId: {
          type: Number,
          value: 0,
          notify: true,
        },
        instrument: {
          type: Object,
          notify: true,
        },
        soundfontUrl: {
          type: String,
          // value: '../../bower_components/soundfonts/FluidR3_GM/',
          value: '../../bower_components/soundfonts/MusyngKite/',
          notify: true,
        },
        loaded: {
          type: Boolean,
          value: false,
          notify: true,
        },
        channel: {
          type: Number,
          value: 0,
          notify: true,
        },
        image: {
          type: String,
          notify: true,
        },
        verbose: {
          type: Boolean,
          notify: true,
        },
      },
      log: function(...args) {
        this.verbose && console.log(this.is, args);
      },
      ready: function() {
        this.log('ready');
      },
      observers: [
        'playNote(note, loaded, channel)',
        'observeNote(note)',
        'observeKey(key)',
        'observeInstrumentId(instrumentId, soundfontUrl, channel)',
      ],
      playNote(note, loaded, channel) {
        this.log('playNote', { note, loaded, channel });
        this.set('key', MIDI.noteToKey[note]);
        loaded && MIDI.noteOn(channel, note, 127, 0);
      },
      observeNote: function(note) {
        this.log('observeNote', { note });
        this.set('key', MIDI.noteToKey[note]);
      },
      observeKey: function(key) {
        this.set('note', MIDI.keyToNote[key]);
      },
      observeInstrumentId: function(id, url, channel) {
        this.log('observeInstrumentId', { id, url });
        this.set('loaded', false);
        this.set('instrument', this.instruments.byId[id]);
        this.set('image', this.resolveUrl('../../bower_components/midi-pictures/' + id + '.jpg'))
        MIDI.soundfontUrl = this.resolveUrl(url);
        MIDI.loadPlugin({
          instrument: this.instruments.byId[id].id,
          onsuccess: this.pluginLoaded.bind(this),
        });
        MIDI.channels[channel].instrument = id;
      },
      pluginLoaded: function(e) {
        this.set('loaded', true);
        this.log(this.instrument, 'loaded');
      },
      play: function(note) {
        this.playNote(note, this.loaded, this.channel);
      },
      filterInstruments: function(category) {
        return instrument => instrument.category === category;
      },
    });
  </script>
</dom-module>